#cloud-config
# Cloud-init configuration for jambonz Feature Server on Azure (Large deployment)

package_update: false
package_upgrade: false

write_files:
  - path: /tmp/jambonz-setup.sh
    permissions: '0755'
    content: |
      #!/bin/bash -xe

      # Variables passed from Terraform
      MYSQL_HOST="${mysql_host}"
      MYSQL_USER="${mysql_user}"
      MYSQL_PASSWORD="${mysql_password}"
      REDIS_HOST="${redis_host}"
      REDIS_PORT="${redis_port}"
      REDIS_PASSWORD="${redis_password}"
      JWT_SECRET="${jwt_secret}"
      MONITORING_PRIVATE_IP="${monitoring_private_ip}"
      VPC_CIDR="${vpc_cidr}"
      URL_PORTAL="${url_portal}"
      KEY_VAULT_NAME="${key_vault_name}"
      RECORDING_WS_BASE_URL="${recording_ws_base_url}"

      echo "Starting jambonz Feature Server configuration for Azure large deployment"

      # Detecting the Linux distribution
      if grep -q 'ID="rhel"' /etc/os-release 2>/dev/null || grep -q 'ID=rhel' /etc/os-release 2>/dev/null; then
          DEFAULT_USER=admin

          echo "Disabling firewalld"
          sudo systemctl stop firewalld || true
          sudo systemctl disable firewalld || true
      else
          DEFAULT_USER=admin
      fi

      # Always use jambonz user for apps
      USER=jambonz
      HOME=/home/jambonz

      # Get instance metadata from Azure IMDS
      echo "Getting instance metadata from Azure IMDS..."
      PUBLIC_IP=$(curl -s -H Metadata:true --noproxy "*" "http://169.254.169.254/metadata/instance/network/interface/0/ipv4/ipAddress/0/publicIpAddress?api-version=2021-02-01&format=text" 2>/dev/null || curl -s https://api.ipify.org)
      PRIVATE_IP=$(curl -s -H Metadata:true --noproxy "*" "http://169.254.169.254/metadata/instance/network/interface/0/ipv4/ipAddress/0/privateIpAddress?api-version=2021-02-01&format=text" 2>/dev/null || hostname -I | awk '{print $1}')
      INSTANCE_ID=$(curl -s -H Metadata:true --noproxy "*" "http://169.254.169.254/metadata/instance/compute/vmId?api-version=2021-02-01&format=text" 2>/dev/null || hostname)

      echo "Public IP: $PUBLIC_IP"
      echo "Private IP: $PRIVATE_IP"
      echo "Instance ID: $INSTANCE_ID"

      echo "Writing $HOME/apps/ecosystem.config.js..."

      cat << EOF > $HOME/apps/ecosystem.config.js
      module.exports = {
      apps : [
      {
          name: 'feature-server',
          cwd: '$HOME/apps/feature-server',
          script: 'app.js',
          instance_var: 'INSTANCE_ID',
          out_file: '$HOME/.pm2/logs/feature-server.log',
          err_file: '$HOME/.pm2/logs/feature-server.log',
          exec_mode: 'fork',
          instances: 'max',
          autorestart: true,
          watch: false,
          max_memory_restart: '5G',
          env: {
            JAMBONES_LOGLEVEL: 'info',
            JAMBONES_TTS_TRIM_SILENCE: 1,
            JWT_SECRET: '$JWT_SECRET',
            JAMBONES_API_BASE_URL: 'http://$URL_PORTAL/v1',
            ENABLE_METRICS: 1,
            STATS_HOST: '127.0.0.1',
            STATS_PORT: 8125,
            STATS_PROTOCOL: 'tcp',
            STATS_TELEGRAF: 1,
            STATS_SAMPLE_RATE: 1,
            JAMBONES_OTEL_ENABLED: 1,
            OTEL_EXPORTER_JAEGER_ENDPOINT: 'http://$MONITORING_PRIVATE_IP:14268/api/traces',
            OTEL_EXPORTER_OTLP_METRICS_INSECURE: 1,
            OTEL_EXPORTER_JAEGER_GRPC_INSECURE: 1,
            JAMBONES_NETWORK_CIDR: '$VPC_CIDR',
            JAMBONES_MYSQL_HOST: '$MYSQL_HOST',
            JAMBONES_MYSQL_USER: '$MYSQL_USER',
            JAMBONES_MYSQL_PASSWORD: '$MYSQL_PASSWORD',
            JAMBONES_MYSQL_DATABASE: 'jambones',
            JAMBONES_MYSQL_CONNECTION_LIMIT: 10,
            JAMBONES_REDIS_HOST: '$REDIS_HOST',
            JAMBONES_REDIS_PORT: $REDIS_PORT,
            JAMBONES_REDIS_PASSWORD: '$REDIS_PASSWORD',
            JAMBONES_TIME_SERIES_HOST: '$MONITORING_PRIVATE_IP',
            HTTP_PORT: 3000,
            HTTP_PORT_MAX: 3009,
            DRACHTIO_HOST: '127.0.0.1',
            DRACHTIO_PORT: 9022,
            DRACHTIO_SECRET: 'cymru',
            JAMBONES_FEATURE_SERVERS: '127.0.0.1:9022:cymru',
            JAMBONES_FREESWITCH: '127.0.0.1:8021:JambonzR0ck\$',
            AUTHENTICATION_KEY: '$JWT_SECRET',
            JAMBONZ_RECORD_WS_USERNAME: 'jambonz',
            JAMBONZ_RECORD_WS_PASSWORD: '$JWT_SECRET',
            JAMBONZ_RECORD_WS_BASE_URL: '$RECORDING_WS_BASE_URL'
          }
        }]
      };
      EOF

      echo "Finished writing config file"

      # Configure freeswitch service
      sudo sed -i -e "s/MYSQL_HOST=/MYSQL_HOST=$MYSQL_HOST/g" /etc/systemd/system/freeswitch.service
      sudo sed -i -e "s/MYSQL_USER=/MYSQL_USER=$MYSQL_USER/g" /etc/systemd/system/freeswitch.service
      sudo sed -i -e "s/MYSQL_PASSWORD=/MYSQL_PASSWORD=$MYSQL_PASSWORD/g" /etc/systemd/system/freeswitch.service
      sudo sed -i -e "s/MYSQL_DATABASE=/MYSQL_DATABASE=jambones/g" /etc/systemd/system/freeswitch.service
      sudo sed -i -e "s/JAMBONES_REDIS_HOST=/JAMBONES_REDIS_HOST=$REDIS_HOST/g" /etc/systemd/system/freeswitch.service
      sudo sed -i -e "s/JAMBONES_REDIS_PORT=/JAMBONES_REDIS_PORT=$REDIS_PORT/g" /etc/systemd/system/freeswitch.service
      sudo sed -i -e "s/JAMBONES_REDIS_PASSWORD=/JAMBONES_REDIS_PASSWORD=$REDIS_PASSWORD/g" /etc/systemd/system/freeswitch.service

      sudo systemctl daemon-reload
      sudo systemctl restart freeswitch

      # Configure telegraf to send to the monitoring server
      sudo sed -i -e "s/influxdb:8086/$MONITORING_PRIVATE_IP:8086/g" /etc/telegraf/telegraf.conf
      sudo systemctl restart telegraf

      sudo -u $USER bash -c "pm2 start $HOME/apps/ecosystem.config.js"
      sudo env PATH=$PATH:/usr/bin /usr/lib/node_modules/pm2/bin/pm2 startup systemd -u $USER --hp $HOME
      sudo -u $USER bash -c "pm2 save"
      sudo systemctl enable pm2-$USER.service

      # Set up scheduled events polling for graceful termination
      echo "Setting up Azure Scheduled Events polling for graceful termination..."
      cat << 'SCRIPT' > /usr/local/bin/check-scheduled-events.sh
      #!/bin/bash
      # Poll Azure Scheduled Events for termination notification
      EVENTS=$(curl -s -H Metadata:true --noproxy "*" "http://169.254.169.254/metadata/scheduledevents?api-version=2020-07-01")
      if echo "$EVENTS" | grep -q '"EventType":"Terminate"'; then
          echo "Termination event detected, initiating graceful shutdown..."
          # Signal jambonz apps to stop accepting new calls
          sudo -u jambonz pm2 sendSignal SIGUSR1 all 2>/dev/null || true
          # Log the event
          echo "$(date): Terminate event received" >> /var/log/jambonz-terminate.log
      fi
      SCRIPT
      chmod +x /usr/local/bin/check-scheduled-events.sh

      # Add cron job to poll every 30 seconds
      echo "* * * * * root /usr/local/bin/check-scheduled-events.sh" >> /etc/crontab
      echo "* * * * * root sleep 30 && /usr/local/bin/check-scheduled-events.sh" >> /etc/crontab

      echo "Feature Server setup complete!"

runcmd:
  - /tmp/jambonz-setup.sh > /var/log/jambonz-setup.log 2>&1

final_message: "jambonz Feature Server cloud-init configuration complete after $UPTIME seconds"
