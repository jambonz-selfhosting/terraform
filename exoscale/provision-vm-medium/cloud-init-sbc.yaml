#cloud-config
# Cloud-init for Jambonz SBC Server on Exoscale

# Merge SSH keys into existing jambonz user
users:
  - name: jambonz
    ssh_authorized_keys:
      - "${ssh_public_key}"

# Configure network interfaces (both public and private)
network:
  version: 2
  ethernets:
    eth0:
      dhcp4: true
    eth1:
      dhcp4: true

write_files:
  - path: /tmp/configure-sbc.sh
    permissions: '0755'
    content: |
      #!/bin/bash -xe
      # Configuration script for jambonz SBC server

      # Variables from Terraform
      MYSQL_HOST="${mysql_host}"
      MYSQL_PORT="${mysql_port}"
      MYSQL_USER="${mysql_user}"
      MYSQL_PASSWORD="${mysql_password}"
      MYSQL_DATABASE="${mysql_database}"
      REDIS_HOST="${redis_host}"
      REDIS_PORT="${redis_port}"
      JWT_SECRET="${jwt_secret}"
      URL_PORTAL="${url_portal}"
      VPC_CIDR="${vpc_cidr}"
      SBC_INDEX="${sbc_index}"

      echo "Starting jambonz SBC-$SBC_INDEX server configuration for Exoscale"

      USER=jambonz
      HOME=/home/jambonz

      # Get instance metadata
      echo "Getting instance metadata..."
      # Get private IP from eth1 (private network interface)
      PRIVATE_IP=$(ip -4 addr show eth1 | grep -oP '(?<=inet\s)\d+(\.\d+){3}' || echo "172.20.0.1")
      INSTANCE_ID=$(curl -s http://169.254.169.254/latest/meta-data/instance-id 2>/dev/null || hostname)
      PUBLIC_IP=$(curl -s https://api.ipify.org)

      echo "Public IP: $PUBLIC_IP"
      echo "Private IP: $PRIVATE_IP (eth1)"
      echo "Instance ID: $INSTANCE_ID"

      # Wait for Redis to be ready
      echo "Waiting for Redis to be ready..."
      until redis-cli -h $REDIS_HOST -p $REDIS_PORT PING &>/dev/null; do
        echo "Redis not ready, waiting..."
        sleep 5
      done

      # Configure drachtio
      echo "Configuring drachtio..."
      cat > /etc/systemd/system/drachtio.service.d/override.conf << EOF
      [Service]
      Environment="JAMBONES_MYSQL_HOST=$MYSQL_HOST:$MYSQL_PORT"
      Environment="JAMBONES_MYSQL_USER=$MYSQL_USER"
      Environment="JAMBONES_MYSQL_PASSWORD=$MYSQL_PASSWORD"
      Environment="JAMBONES_MYSQL_DATABASE=$MYSQL_DATABASE"
      Environment="JAMBONES_REDIS_HOST=$REDIS_HOST"
      Environment="JAMBONES_REDIS_PORT=$REDIS_PORT"
      Environment="DRACHTIO_HOST=$PRIVATE_IP"
      Environment="SOFIA_SEARCH_DOMAINS=1"
      EOF

      systemctl daemon-reload
      systemctl restart drachtio

      # Configure rtpengine
      echo "Configuring rtpengine..."
      sed -i "s/PRIVATE_IP_PLACEHOLDER/$PRIVATE_IP/g" /etc/rtpengine/rtpengine.conf || true
      sed -i "s/PUBLIC_IP_PLACEHOLDER/$PUBLIC_IP/g" /etc/rtpengine/rtpengine.conf || true

      systemctl restart rtpengine

      # Write PM2 ecosystem config for SBC sidecars
      echo "Writing ecosystem.config.js for SBC..."
      cat << 'EOFECO' > $HOME/apps/ecosystem.config.js
      module.exports = {
        apps : [
        {
          name: 'sbc-sip-sidecar',
          cwd: '/home/jambonz/apps/sbc-sip-sidecar',
          script: 'app.js',
          out_file: '/home/jambonz/.pm2/logs/sbc-sip-sidecar.log',
          err_file: '/home/jambonz/.pm2/logs/sbc-sip-sidecar.log',
          combine_logs: true,
          autorestart: true,
          watch: false,
          max_memory_restart: '1G',
          env: {
            JAMBONES_LOGLEVEL: 'info',
            JAMBONES_MYSQL_HOST: 'MYSQL_HOST_PORT_PLACEHOLDER',
            JAMBONES_MYSQL_USER: 'MYSQL_USER_PLACEHOLDER',
            JAMBONES_MYSQL_PASSWORD: 'MYSQL_PASSWORD_PLACEHOLDER',
            JAMBONES_MYSQL_DATABASE: 'MYSQL_DATABASE_PLACEHOLDER',
            JAMBONES_REDIS_HOST: 'REDIS_HOST_PLACEHOLDER',
            JAMBONES_REDIS_PORT: REDIS_PORT_PLACEHOLDER,
            DRACHTIO_HOST: '127.0.0.1',
            DRACHTIO_PORT: 9022,
            DRACHTIO_SECRET: 'cymru',
            JAMBONES_NETWORK_CIDR: 'VPC_CIDR_PLACEHOLDER',
            JAMBONES_SBC_SIP_INTERFACE: 'PRIVATE_IP_PLACEHOLDER'
          }
        },
        {
          name: 'sbc-rtpengine-sidecar',
          cwd: '/home/jambonz/apps/sbc-rtpengine-sidecar',
          script: 'app.js',
          out_file: '/home/jambonz/.pm2/logs/sbc-rtpengine-sidecar.log',
          err_file: '/home/jambonz/.pm2/logs/sbc-rtpengine-sidecar.log',
          combine_logs: true,
          autorestart: true,
          watch: false,
          max_memory_restart: '1G',
          env: {
            JAMBONES_LOGLEVEL: 'info',
            JAMBONES_REDIS_HOST: 'REDIS_HOST_PLACEHOLDER',
            JAMBONES_REDIS_PORT: REDIS_PORT_PLACEHOLDER,
            RTPENGINE_HOST: '127.0.0.1',
            RTPENGINE_PORT: 22222
          }
        }]
      };
      EOFECO

      # Replace placeholders
      sed -i "s/MYSQL_HOST_PORT_PLACEHOLDER/$MYSQL_HOST:$MYSQL_PORT/g" $HOME/apps/ecosystem.config.js
      sed -i "s/MYSQL_USER_PLACEHOLDER/$MYSQL_USER/g" $HOME/apps/ecosystem.config.js
      sed -i "s/MYSQL_PASSWORD_PLACEHOLDER/$MYSQL_PASSWORD/g" $HOME/apps/ecosystem.config.js
      sed -i "s/MYSQL_DATABASE_PLACEHOLDER/$MYSQL_DATABASE/g" $HOME/apps/ecosystem.config.js
      sed -i "s/REDIS_HOST_PLACEHOLDER/$REDIS_HOST/g" $HOME/apps/ecosystem.config.js
      sed -i "s/REDIS_PORT_PLACEHOLDER/$REDIS_PORT/g" $HOME/apps/ecosystem.config.js
      sed -i "s/VPC_CIDR_PLACEHOLDER/$VPC_CIDR/g" $HOME/apps/ecosystem.config.js
      sed -i "s/PRIVATE_IP_PLACEHOLDER/$PRIVATE_IP/g" $HOME/apps/ecosystem.config.js

      # Start PM2 apps
      su - $USER -c "pm2 delete all || true"
      su - $USER -c "pm2 start $HOME/apps/ecosystem.config.js"
      su - $USER -c "pm2 save"

      # Configure apiban if key is provided
      APIBAN_KEY="${apiban_key}"
      if [ -n "$APIBAN_KEY" ] && [ -f /usr/local/bin/apiban/config.json ]; then
          echo "Configuring APIBan with provided key..."
          sudo sed -i -e "s/API-KEY-HERE/$APIBAN_KEY/g" /usr/local/bin/apiban/config.json
          sudo /usr/local/bin/apiban/apiban-client-nftables FULL || true
      else
          echo "Skipping APIBan configuration (no key provided)"
      fi

      echo "SBC-$SBC_INDEX server configuration complete!"

runcmd:
  - /tmp/configure-sbc.sh

final_message: "Jambonz SBC server is ready!"
